# Setting up a newly-generated Jailhouse Images QEMU image

## Resize QEMU Image

Before running the QEMU image, resize it:

    qemu-img resize demo-image-qemuamd64-jailhouse-demo-qemuamd64.ext4.img +10G

Start the QEMU image:

   ./start-qemu-x86.sh

Then finish the resize process:

    resize2fs /dev/sda

See:
* https://groups.google.com/forum/#!topic/jailhouse-dev/3IMPKkNUguQ
* https://groups.google.com/forum/#!topic/jailhouse-dev/yvGRjoHVBSc

## Accessing the the outside world

To access the outside world from the guest, first make sure that the host has an
ssh server (sshd) running:

    apt install openssh-server

Then, simply do `ssh <user>@10.0.2.2`! See
https://wiki.qemu.org/Documentation/Networking
Once this is set up, SCP can be used to transfer files to and from the guest.

NOTE: `apt install <package>` also works out of the box!

Note that `ping google.com` won't work, because the protocol PING uses isn't
implemented in QEMU (I just remembered dealing with that a while back).

## Install packages

Install useful packages:

    apt install vim git tmux curl wget sudo ncdu

Install packages to enable git clone:

    apt install ca-certificates

Install packages to build Jailhouse and UIO kernel module:

    apt install libelf-dev build-essential

Install other optional packages:

    apt install python3, hwloc, tmux, pip3, mariadb-server, mariadb-client, libmariadb-dev, munge, libmunge-dev, libssl-dev, libtool, apt-transport-https, gnupg2, software-properties-common

Set up correct timezone:

    sudo dpkg-reconfigure tzdata


## Setting up non-root user

    adduser hintron
    usermod -aG sudo hintron

This will disable logging in as root.
To change the password:

    passwd

To switch to user root:

    sudo su root

Copy select contents of root home dir to user. Don't forget ssh keys, if already
set up!

Switch back:

    exit

Recursively `chown` the files as the user:

    sudo chown -R hintron: ~


See https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-ubuntu-quickstart

TODO: Copy and chmod root ~ to user ~.


## `sudo: unable to resolve host demo`

Edit or create /etc/hosts:

    sudo vim /etc/hosts

Make sure this is there:

    127.0.0.1   localhost
    127.0.1.1   demo

## Install Linux headers from Jailhouse Image output

To get the Linux headers from the host machine into the QEMU guest, use `scp` to
copy out the Linux headers generated by Jailhouse Images. They are stored in
`out/build/tmp/deploy/apt/jailhouse-demo/pool/main/l/linux-<version>/`,
where `<version>` is the Linux kernel version that was built.

E.g.:

    `scp hintron@10.0.2.2:/home/hintron/code/jailhouse-images/out/build/tmp/deploy/apt/jailhouse-demo/pool/main/l/linux-4.14.73/linux-headers-jailhouse_*.deb .`

Now use `dpkg` to install the headers:

    dpkg -i ./linux-headers-jailhouse_*.deb
    # or
    # apt install ./linux-headers-jailhouse_*.deb

See https://groups.google.com/d/topic/jailhouse-dev/hV-5AkuZqbg/discussion


## Set up SSH keys for convenience

Generate an SSH key for the QEMU image and copy it out to the host:

    ssh-keygen
    scp ~/.ssh/id_rsa.pub hintron@10.0.2.2:~/Downloads/jhdemo-id_rsa.pub

From the host, copy and paste the contents of the key file to add the key to
GitHub for ease of pushing/pulling git repos.

## Setup Git

Download my gitconfig snippet from bitbucket to QEMU Host.
In QEMU guest, do:

    scp hintron@10.0.2.2:/home/hintron/Downloads/gitconfig.txt /etc/gitconfig

Or, add ssh key to bitbucket as well and git clone the snippet:

    git clone git@bitbucket.org:snippets/kolob/LRE5b/git-configs.git

## Clone Jailhouse + MGH additions (this repo)

    git clone git@github.com:hintron/jailhouse ~/jailhouse

## Setup upstream remote:

    git remote add upstream https://github.com/siemens/jailhouse

## Build Jailhouse

    cd ~/jailhouse
    make install

## Build UIO ivshmem Kernel Module

    cd mgh/ivshmem/uio_kernel_module
    make install
    cd ../../..

## Install Kernel modules

Check to make sure that the Jailhouse and UIO kernel modules are loaded.

    lsmod | grep -i jailhouse
    lsmod | grep -i ivshmem

The build commands will install the .ko files in the right place for the
next bootup, but to load them ad-hoc without rebooting the machine, do the
following:

    insmod driver/jailhouse.ko
    insmod mgh/ivshmem/uio_kernel_module/uio_ivshmem.ko

You can manually remove them like so:

    rmmod jailhouse
    rmmod uio_ivshmem

## References:

* "Problem with the SSL CA cert (path? access rights?)" See https://stackoverflow.com/questions/7179216/php-problem-with-the-ssl-ca-cert-path-access-rights)

* See https://unix.stackexchange.com/questions/159094/how-to-install-a-deb-file-by-dpkg-i-or-by-apt
